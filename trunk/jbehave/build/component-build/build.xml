<project name="jbehave" default="verify">
    <property name="project" value="${ant.project.name}"/>
    <property name="version" value="0.1.0"/>

    <!-- optional local settings -->
    <property file="../build.properties"/>

    <property name="src.dir" location="../src"/>
    <property name="behaviour.dir" location="../behaviour" />
    <property name="lib.dir" location="../lib"/>
    <property name="working.dir" location="delete_me"/>
    <property name="classes.dir" location="${working.dir}/classes" />
    <property name="behaviour.classes.dir" location="${working.dir}/behaviours" />

    <property name="dist.dir" location="dist"/>
    <property name="dist.jar.file" location="${dist.dir}/${project}-${component.name}.jar" />

    <target name="-init">
        <!-- sanity checks -->
        <fail message="Property 'component.name' not found" unless="component.name"/>
        <fail message="Property 'all.behaviours.class' not found" unless="all.behaviours.class"/>
        <fail message="Property 'version' not found" unless="version"/>
        <mkdir dir="${working.dir}" />
    </target>

    <target name="-copy.core.jar">
        <copy file="${core.jar}" todir="${lib.dir}"/>
    </target>

    <target name="src.compile" depends="-init">
        <mkdir dir="${classes.dir}"/>
        <javac srcdir="${src.dir}" destdir="${classes.dir}" debug="yes">
            <classpath id="external_jars_only">
                <fileset dir="${lib.dir}" includes="*.jar"/>
            </classpath>
        </javac>
    </target>

    <target name="jar" depends="src.compile">
        <mkdir dir="${dist.dir}" />
        <copy todir="${classes.dir}">
            <fileset dir="${src.dir}" excludes="**/*.java" />
        </copy>
        <mkdir dir="${classes.dir}/${version}"/>
        <echo message="${version}" file="${classes.dir}/${version}/version.txt"/>
        <jar basedir="${classes.dir}" destfile="${dist.jar.file}"/>
    </target>

    <target name="behaviour.compile" depends="jar">
        <mkdir dir="${behaviour.classes.dir}"/>
        <javac srcdir="${behaviour.dir}" destdir="${behaviour.classes.dir}" debug="yes">
            <classpath id="dist_jar_with_external_jars">
                <path location="${dist.jar.file}"/>
                <path refid="external_jars_only"/>
            </classpath>
        </javac>
    </target>

    <target name="verify" depends="behaviour.compile">
        <java classname="jbehave.framework.Run" fork="true" failonerror="true">
            <classpath id="all_jars_plus_behaviours">
                <path location="${behaviour.classes.dir}"/>
                <path refid="dist_jar_with_external_jars"/>
            </classpath>
            <arg value="${all.behaviours.class}"/>
        </java>
    </target>

    <target name="dist" depends="verify"/>

    <target name="clean">
        <delete dir="${working.dir}" />
    </target>

    <target name="clobber" depends="clean">
        <delete dir="${dist.dir}" />
    </target>

    <target name="rebuild" depends="clobber, verify"/>
</project>
