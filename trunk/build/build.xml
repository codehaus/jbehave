<project name="jbehave" default="rebuild">
  <property name="working_dir" location="delete_me" />
  <property name="classes_dir" location="${working_dir}/classes" />
  <property name="core_classes_dir" location="${classes_dir}/core" />
  <property name="full_classes_dir" location="${classes_dir}/full" />
  <property name="behaviour_classes_dir" location="${working_dir}/behaviour-classes" />
  <property name="core_behaviour_classes_dir" location="${behaviour_classes_dir}/core" />
  <property name="full_behaviour_classes_dir" location="${behaviour_classes_dir}/full" />
  <property name="javadoc_working_dir" location="${working_dir}/javadoc"/>

  <property name="core_dir" location="../core" />
  <property name="extensions_dir" location="../extensions" />
  <property name="lib_dir" location="../lib" />
  <property name="core_jar_file" location="${working_dir}/jbehave-core.jar" />
  
  <path id="LIBS">
    <fileset dir="${lib_dir}" includes="**/*.jar, **/*.zip" />
  </path>

  <target name="-init">
    <mkdir dir="${working_dir}" />
  </target>
  <target name="clean">
    <delete dir="${working_dir}" />
  </target>

  <target name="build-core-jar" depends="-init">
    <mkdir dir="${core_classes_dir}" />
    <javac srcdir="${core_dir}/src" destdir="${core_classes_dir}" source="1.3" target="1.3" classpathref="LIBS" />
    <copy todir="${core_classes_dir}" includeemptydirs="no">
      <fileset dir="${core_dir}/src" excludes="**/*.java" />
    </copy>
    <jar basedir="${core_classes_dir}" jarfile="${core_jar_file}" />
  </target>

  <target name="verify-core-jar" depends="build-core-jar">
    <mkdir dir="${core_behaviour_classes_dir}" />
    <javac taskname="compile core behaviours" destdir="${core_behaviour_classes_dir}" source="1.3" target="1.3"
      srcdir="${core_dir}/behaviour"
      classpath="${core_jar_file}" />
    <java taskname="run core behaviours" classname="jbehave.core.Run" fork="true">
      <arg value="jbehave.core.AllBehaviours" />
      <classpath>
        <pathelement path="${core_behaviour_classes_dir}" />
        <pathelement path="${core_jar_file}" />
      </classpath>
    </java>
  </target>

  <target name="build-full-jar" depends="build-core-jar">
    <mkdir dir="${full_classes_dir}" />
    <javac destdir="${full_classes_dir}" source="1.3" target="1.3">
      <src>
        <dirset dir="${extensions_dir}" includes="**/src" />
      </src>
      <classpath>
        <pathelement path="${core_jar_file}" />
        <path refid="LIBS" />
      </classpath>
    </javac>
    <copy todir="${full_classes_dir}" includeemptydirs="no">
      <fileset dir="${extensions_dir}">
        <include name="**/src/**" />
        <exclude name="**/*.java" />
      </fileset>
      <mapper HERE />
    </copy>
    <jar basedir="${core_classes_dir}" jarfile="${core_jar_file}" />
  </target>

  <target name="verify-full-jar" depends="build-full-jar">
    <mkdir dir="${core_behaviour_classes_dir}" />
    <javac taskname="compile core behaviours" destdir="${core_behaviour_classes_dir}" source="1.3" target="1.3"
      srcdir="${core_dir}/behaviour">
      <classpath>
        <pathelement path="${core_jar_file}" />
        <path refid="LIBS" />
      </classpath>
    </javac>
    <java taskname="run core behaviours" classname="jbehave.core.Run" fork="true">
      <arg value="jbehave.core.AllBehaviours" />
      <classpath>
        <pathelement path="${core_behaviour_classes_dir}" />
        <pathelement path="${core_jar_file}" />
        <path refid="LIBS" />
      </classpath>
    </java>
  </target>

  <target name="rebuild" depends="clean, verify-core-jar" />

  <target name="javadoc">
    <mkdir dir="${javadoc_working_dir}" />
    <javadoc destdir="${javadoc_working_dir}" windowtitle="JBehave API Documentation" verbose="false" useexternalfile="true">
      <fileset dir="${extensions_dir}">
        <include name="*/src/**/*.java" />
        <exclude name="**/codegen/**" />
      </fileset>
      <fileset dir="${core_dir}">
        <include name="src/**/*.java" />
      </fileset>
      <classpath refid="LIBS" />
      <group title="Core API" packages="jbehave.core*" />
      <group title="JMock Extension" packages="jbehave.jmock*" />
      <group title="Ant Task Extension" packages="jbehave.ant*" />
      <group title="JUnit Adapter" packages="jbehave.junit*" />
      <group title="Story Runner" packages="jbehave.story*" />
      <classpath>
        <fileset dir="${lib_dir}" includes="*.jar, *.zip" />
      </classpath>
    </javadoc>
  </target>
</project>
