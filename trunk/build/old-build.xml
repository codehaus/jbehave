<project name="jbehave" basedir="." default="dist">

    <!-- PROPERTIES -->
    <property name="project" value="${ant.project.name}"/>
    <property file="version.properties"/>

    <!-- working area stuff -->
    <property name="working_dir" location="delete_me" />
    <property name="javadoc_working_dir" location="${working_dir}/javadoc" />

    <!-- dist stuff -->
    <property name="dist_dir" location="dist"/>
    <property name="website_dist_dir" location="${dist_dir}/website"/>
    <property name="javadoc_dist_dir" location="${website_dist_dir}/docs/javadoc"/>
    <property name="website_download_dir" location="${website_dist_dir}/dist"/>

    <!-- core -->
    <property name="core.dir" location="../core"/>
    <property name="core.build.dir" location="${core.dir}/build"/>
    <property name="core.src.dir" location="${core.dir}/src"/>

    <!-- extensions -->
    <property name="extensions_dir" location="../extensions"/>

    <!-- website -->
    <property name="website_dir" location="../website"/>

    <target name="-init">
        <fail message="Version not defined" unless="version"/>
    </target>

    <!-- BUILD AND ASSEMBLY TARGETS -->

    <target name="core" depends="-init">
        <ant dir="${core.dir}" antfile="build/build.xml" target="dist">
            <property name="version" value="${version}"/>
            <property name="dist_dir" location="${dist_dir}"/>
        </ant>
    </target>

    <target name="extensions" depends="core">
        <subant target="-copy.core.jar" failonerror="true">
            <property name="core.jar" value="${dist_dir}/${project}-core.jar"/>
            <dirset dir="${extensions_dir}" includes="*/build" excludes="component-skeleton/build"/>
        </subant>
        <subant target="dist" failonerror="true">
            <property name="version" value="${version}"/>
            <property name="dist_dir" location="${dist_dir}"/>
            <dirset dir="${extensions_dir}" includes="*/build" excludes="component-skeleton/build"/>
        </subant>
    </target>

    <!-- WEBSITE TARGETS -->

    <target name="website">
        <exec executable="ruby" dir="${website_dir}">
            <arg value="skinner.rb"/>
        </exec>
    </target>

    <target name="javadoc">
        <mkdir dir="${javadoc_working_dir}"/>
        <javadoc destdir="${javadoc_working_dir}"
                windowtitle="JBehave API Documentation"
                useexternalfile="true"
                verbose="true">

            <fileset dir="${extensions_dir}">
                <include name="*/src/**/*.java"/>
            </fileset>
            <fileset dir="${core.src.dir}">
                <include name="**/*.java"/>
            </fileset>

            <group title="Core API" packages="com.thoughtworks.jbehave.core*"/>
            <group title="JMock Extension" packages="com.thoughtworks.jbehave.extensions.jmock*"/>
            <group title="Ant Task Extension" packages="com.thoughtworks.jbehave.extensions.ant*"/>
            <group title="JUnit Adapter" packages="com.thoughtworks.jbehave.extensions.junit*"/>
            <group title="Story Runner" packages="com.thoughtworks.jbehave.extensions.story*"/>
        </javadoc>
    </target>

    <target name="srcjar">
        <jar destfile="${dist_dir}/${project}-src.jar">
            <zipfileset dir=".." prefix="jbehave-${version}">
                <exclude name="**/*.class" />
                <exclude name="**/bin/**" />
                <exclude name="**/classes/**" />
                <exclude name="**/dist/**" />
                <exclude name="**/delete_me/**"/>
                <exclude name="**/jbehave-core*.jar"/>
                <exclude name="website/output/**"/>
            </zipfileset>
        </jar>
    </target>

    <target name="dist" depends="core, extensions, website, javadoc, srcjar">
        <copy todir="${website_dist_dir}">
            <fileset dir="${website_dir}/output" />
        </copy>
        <copy todir="${javadoc_dist_dir}">
            <fileset dir="${javadoc_working_dir}" />
        </copy>
        <copy todir="${website_download_dir}">
            <fileset dir="${dist_dir}" includes="jbehave-*.jar"/>
        </copy>
    </target>

    <!-- HOUSEKEEPING TARGETS -->

    <target name="clean" >
        <delete dir="${working_dir}" />
    </target>

    <target name="clobber" depends="clean">
        <delete dir="${dist_dir}" />
        <subant target="clobber">
            <property name="version" value="${version}"/>
        <property name="dist_dir" location="${dist_dir}"/>
            <dirset dir="${extensions_dir}" includes="*/build" excludes="component-skeleton/build"/>
        </subant>
    </target>
</project>
