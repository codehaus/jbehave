<project name="jbehave" basedir=".." default="verify">
    <property name="project" value="${ant.project.name}"/>
    <property name="version" value="0.2.0"/>

    <!-- optional local settings -->
    <property file="build.properties"/>

    <property name="src.dir" location="src"/>
    <property name="behaviour.dir" location="behaviour" />
    <property name="lib.dir" location="../../lib"/>
    <property name="build.dir" location="build"/>
    <property name="working.dir" location="${build.dir}/delete_me"/>
    <property name="classes.dir" location="${working.dir}/classes" />
    <property name="behaviour.classes.dir" location="${working.dir}/behaviours" />

    <property name="dist.dir" location="${build.dir}/dist"/>
    <property name="dist.jar.file" location="${dist.dir}/${project}-${component.name}.jar" />

    <path id="external_jars">
        <fileset dir="${lib.dir}" includes="**/*.jar"/>
    </path>
    
    <path id="dist_jar_with_external_jars">
        <path location="${dist.jar.file}"/>
        <path refid="external_jars"/>
    </path>

    <path id="all_jars_plus_behaviours">
        <path refid="dist_jar_with_external_jars"/>
        <path location="${behaviour.classes.dir}"/>
    </path>
    
    <target name="-init">
        <!-- sanity checks -->
        <fail message="Property 'component.name' not found" unless="component.name"/>
        <fail message="Property 'all.behaviours.class' not found" unless="all.behaviours.class"/>
        <fail message="Property 'version' not found" unless="version"/>
        <mkdir dir="${working.dir}" />
    </target>

    <target name="-copy.core.jar">
        <copy file="${core.jar}" todir="${lib.dir}"/>
    </target>

    <target name="src.compile" depends="-init">
        <mkdir dir="${classes.dir}"/>
        <javac srcdir="${src.dir}" destdir="${classes.dir}" debug="yes" classpathref="external_jars"/>
    </target>

    <target name="jar" depends="src.compile">
        <mkdir dir="${dist.dir}" />
        <copy todir="${classes.dir}">
            <fileset dir="${src.dir}" excludes="**/*.java" />
        </copy>
        <mkdir dir="${classes.dir}/${version}"/>
        <echo message="${version}" file="${classes.dir}/${version}/version.txt"/>
        <jar basedir="${classes.dir}" destfile="${dist.jar.file}"/>
    </target>

    <target name="behaviour.compile" depends="jar">
        <mkdir dir="${behaviour.classes.dir}"/>
        <javac srcdir="${behaviour.dir}" destdir="${behaviour.classes.dir}" debug="yes" classpathref="dist_jar_with_external_jars"/>
    </target>

    <target name="verify" depends="behaviour.compile">
        <java classname="com.thoughtworks.jbehave.core.Run" fork="true" failonerror="true"
            classpathref="all_jars_plus_behaviours">
            <arg value="${all.behaviours.class}"/>
        </java>   
    </target>

    <target name="dist" depends="verify"/>

    <target name="clean">
        <delete dir="${working.dir}" />
    </target>

    <target name="clobber" depends="clean">
        <delete dir="${dist.dir}" />
    </target>

    <target name="rebuild" depends="clobber, verify"/>
</project>
