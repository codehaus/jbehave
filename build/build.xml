<project name="jbehave" default="rebuild">
  <property name="working_dir" location="delete_me" />
  <property name="classes_dir" location="${working_dir}/classes" />
  <property name="behaviour_classes_dir" location="${working_dir}/behaviour-classes" />
  <property name="javadoc_working_dir" location="${working_dir}/javadoc"/>

  <property name="core_dir" location="../core" />
  <property name="extensions_dir" location="../extensions" />
  <property name="lib_dir" location="../lib" />
  <property name="jar_file" location="${working_dir}/jbehave.jar" />
  
  <path id="LIBS">
    <fileset dir="${lib_dir}" includes="**/*.jar, **/*.zip" />
  </path>
  
  <taskdef resource="net/sf/antcontrib/antlib.xml" classpath="ant-contrib.jar" />

  <target name="-init">
    <mkdir dir="${working_dir}" />
  </target>
  <target name="clean">
    <delete dir="${working_dir}" />
  </target>

  <target name="build-jar" depends="-init">
    <mkdir dir="${classes_dir}" />
    <javac srcdir="${core_dir}/src" destdir="${classes_dir}" source="1.3" target="1.3" classpathref="LIBS" debug="true">
      <src>
        <pathelement path="${core_dir}/src" />
        <dirset dir="${extensions_dir}" includes="**/src" />
      </src>
    </javac>
    <copy todir="${classes_dir}" includeemptydirs="no">
      <fileset dir="${core_dir}" includes="src/**" excludes="**/*.java, **/package.html" />
      <fileset dir="${extensions_dir}" includes="**/src/**" excludes="**/*.java, **/package.html" />
      <regexpmapper from="(.*/)?src/(.*)" to="\2" handledirsep="true" />
    </copy>
    <jar basedir="${classes_dir}" jarfile="${jar_file}" />
  </target>

  <target name="verify-jar" depends="build-jar">
    <mkdir dir="${behaviour_classes_dir}" />
    <javac taskname="compile behaviours" destdir="${behaviour_classes_dir}" source="1.3" target="1.3">
      <src>
        <pathelement path="${core_dir}/behaviour" />
        <pathelement path="../everything/behaviour" />
        <dirset dir="${extensions_dir}" includes="**/behaviour" />
      </src>
      <classpath>
          <pathelement path="${jar_file}" />
          <path refid="LIBS" />
      </classpath>
    </javac>
    <java taskname="run behaviours" classname="jbehave.core.Run" fork="true" failonerror="true">
      <arg value="jbehave.AllBehaviours" />
      <classpath>
        <pathelement path="${behaviour_classes_dir}" />
        <pathelement path="${jar_file}" />
        <path refid="LIBS" />
      </classpath>
    </java>
  </target>
  
  <target name="rebuild" depends="clean, verify-jar" />

  <target name="javadoc">
    <mkdir dir="${javadoc_working_dir}" />
    <javadoc destdir="${javadoc_working_dir}" windowtitle="JBehave API Documentation" verbose="false" useexternalfile="true">
      <fileset dir="${extensions_dir}">
        <include name="*/src/**/*.java" />
        <exclude name="**/codegen/**" />
      </fileset>
      <fileset dir="${core_dir}">
        <include name="src/**/*.java" />
      </fileset>
      <classpath refid="LIBS" />
      <group title="Core API" packages="jbehave.core*" />
      <group title="JMock Extension" packages="jbehave.jmock*" />
      <group title="Ant Task Extension" packages="jbehave.ant*" />
      <group title="JUnit Adapter" packages="jbehave.junit*" />
      <group title="Story Runner" packages="jbehave.story*" />
      <classpath>
        <fileset dir="${lib_dir}" includes="*.jar, *.zip" />
      </classpath>
    </javadoc>
  </target>
</project>
